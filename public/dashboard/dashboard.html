<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD</title>

    <link rel="stylesheet" href="../css/dashboard.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="obterDados()">
    <div class="main">
        <div class="navbar">
            <div class="perfil">
                <img id="fotoPerfil" src="" alt="">
                <div class="hello">
                    <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
                </div>
            </div>
            <ul>
                <li class="agora">
                    <a href="#">DASHBOARD</a>
                </li>
                <li>
                    <a href="../jogo.html">JOGAR</a>
                </li>
            </ul>
                <a href="../index.html">SAIR</a>
        </div>

        <div class="container">
            
            <div class="kpis">
                <div class="kpi">
                    <h3>Sua maior pontuação:</h3>
                    <p id="kpiMaiorPontuacao">0</p>
                </div>
                
                <div class="kpi">
                    <h3>Suas partidas jogadas:</h3>
                    <p id="kpiQtdPartidas">KPI</p>
                </div>

                <div class="kpi">
                    <h3>Usuários cadastrados:</h3>
                    <p id="kpiTotalUsuarios">0</p>
                </div>
            </div>
            
                

            <div class="graficos">
                <div class="grafico">
                    <h3>Top 3 maiores pontuações:</h3>
                    <canvas id="graficoBarra"></canvas>
                </div>

                <div class="grafico">
                    <div class="piz">
                        <h3>Personagens mais escolhidos:</h3>
                        <canvas id="graficoPizza"></canvas>
                    </div>
                </div>
            </div>
                

        </div>
    </div>
</body>
</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    fkPersonagem = sessionStorage.FK_PERSONAGEM;

    if (fkPersonagem == 1) {
        fotoPerfil.src = "../assets/imgs/perfilOnze.jpeg";
    } else if (fkPersonagem == 2) {
        fotoPerfil.src = "../assets/imgs/perfilMike.jpeg";
    } else if (fkPersonagem == 3) {
        fotoPerfil.src = "../assets/imgs/perfilDustin.jpeg";
    } else if (fkPersonagem == 4) {
        fotoPerfil.src = "../assets/imgs/perfilWill.jpeg";
    } else if (fkPersonagem == 5) {
        fotoPerfil.src = "../assets/imgs/perfilLucas.jpeg";
    } else {
        fotoPerfil.src = "../assets/imgs/perfilMax.jpeg";
    }

    function obterDados() {
        fetch("/partidas/buscarTop3")
            .then(function(response){
                return response.json();
            })
            .then(function(data){
                console.log("Top3 recebido:");
                plotarGraficoBarra(data);
            })
            .catch(function(err){
                console.error("Erro ao buscar top3:", err);
            })

            fetch("/partidas/personagensEscolhidos")
            .then(function(response){
                return response.json();
            })
            .then(function(data){
                console.log("Personagens recebidos:");
                plotarGraficoPizza(data);
            })
            .catch(function(err){
                console.error("Erro ao buscar personagens:", err);
            })

            obterKpiMaiorPontuacao();
            obterKpiTotalUsuarios();  
            obterKpiQtdPartidas();  
    }

function obterKpiMaiorPontuacao() {
    fetch(`/partidas/maiorPontuacao/${sessionStorage.ID_USUARIO}`)
        .then(r => r.json())
        .then(resposta => {
            document.getElementById("kpiMaiorPontuacao").innerHTML =
                resposta[0].maiorPontuacao;
        })
        .catch(erro => console.error("Erro KPI pontuação:", erro));
}

function obterKpiQtdPartidas() {
    fetch(`/partidas/qtdPartidas/${sessionStorage.ID_USUARIO}`)
        .then(r => r.json())
        .then(resposta => {
            document.getElementById("kpiQtdPartidas").innerHTML =
                resposta[0].qtdPartidas;
        })
        .catch(erro => console.error("Erro KPI quantidade de partidas:", erro));
}

function obterKpiTotalUsuarios() {
    fetch("/usuarios/totalUsuarios")
        .then(r => r.json())
        .then(resposta => {
            document.getElementById("kpiTotalUsuarios").innerHTML =
                resposta[0].totalUsuarios;
        })
        .catch(erro => console.error("Erro KPI total usuários:", erro));
}

    function plotarGraficoBarra(dados){
        var nomes = [];
        var pontuacoes = [];

        for (var i = 0; i < dados.length; i++){
            nomes.push(dados[i].nome);
            pontuacoes.push(dados[i].pontuacao);
        }

        var ctx = document.getElementById('graficoBarra').getContext('2d');

        var graficoBarra = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nomes,
                datasets: [{
                    label: 'Pontuação',
                    data: pontuacoes,
                    borderWidth: 2,
                    borderColor: ['rgba(99, 132, 255, 1)',
                                'rgba(99, 132, 255, 1)',
                                'rgba(99, 132, 255, 1)',
                    ],
                    backgroundColor: 'rgba(99, 132, 255, 0.3)',
                }]
            },
            options: {
                scales: {
                    y: {
                        ticks: {
                            color: '#fff'
                        },
                        grid: {
                            color: '#D3D3D3'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#fff',
                            font: {
                                size: 14
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#fff',
                            font: {
                                size: 13
                            },
                        }
                    }
                }
            }
        });
    }

    
    function plotarGraficoPizza(dados){
        var personagens = [];
        var quantidades = [];

        for (var i = 0; i < dados.length; i++){
            personagens.push(dados[i].nome);
            quantidades.push(dados[i].qtdEscolhido);
        }

        var ctx2 = document.getElementById('graficoPizza').getContext('2d');

        new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: personagens,
                datasets: [{
                    label: 'Personagens mais escolhidos',
                    data: quantidades,
                    borderWidth: 2,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgb(180, 70, 120, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgb(180, 70, 120, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ]
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#fff',
                            font: {
                                size: 13
                            },
                        }
                    }
                }
            }
        });
    }
</script>